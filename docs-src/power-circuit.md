# LED がちらつく場合

「常時 HIGH（点灯固定）のはずなのに揺らいで見える」場合は、PWMやソフトではなく**電源・配線・ピン特性**が原因であることがほとんどです。ESP32特有の“あるある”順に原因と対処をまとめます。

## 主因（よくある順）

1. **Wi-Fi/BLE送信での電源ドロップ**

* ESP32は無線送信の瞬間に短い電流ピークが出ます（数十〜数百mA級のスパイク）。3.3Vがわずかに窪む→LED電流が変わり**明るさが脈動**。おおよそ100ms程度の周期で見えることも。
* 対策

  * 5V側に**470–1000µF**、3.3V側に**47–100µF + 0.1µF**を**モジュールのすぐ近く**に。
  * しっかりした電源（5V 1A以上）・短いGND/電源配線・スター配線。
  * 検証用に**Wi-Fi/BLEをOFF**して比較（揺らぎが消えれば電源原因ほぼ確）。
  * 必要ならModem-sleep等の省電力を無効化して電流変動を減らす。

2. **配線・グラウンドのインピーダンス/ノイズ拾い**

* ブレッドボードや細い長尺ワイヤでGNDにインピーダンス→**グラウンドバウンス**でLED電流が揺れる。
* 対策：太く短い配線、GNDを一点化、LED近傍に0.1µF。

3. **“ソース駆動”の不安定さ**

* GPIOをHIGHにして**3.3V→GPIO→抵抗→LED→GND**の順（ソース駆動）だと、VDDの小さな揺れが**そのままLEDに乗りやすい**。
* 対策：**シンク駆動**に変更（3.3V→抵抗→LED→GPIO、GPIO=LOWで点灯）。GPIOのLOWはGNDに引っ張るので、VDD揺れの影響が小さくなり安定しやすい。

4. **ドライブ能力/設定の問題**

* `GPIO_MODE_OUTPUT_OD`（オープンドレイン）にしている、プルアップが残っている、ドライブ能力が弱い等で波形が鈍る/揺れる。
* 対策：

  * `gpio_set_direction(pin, GPIO_MODE_OUTPUT);`
  * `gpio_pullup_dis(pin); gpio_pulldown_dis(pin);`
  * `gpio_set_drive_capability(pin, GPIO_DRIVE_CAP_2/3/4)` を上げて試す。
  * 直列抵抗は**適正値(330–1kΩ目安)**を必ず入れる。

5. **不適切なGPIO/他機能の割当が干渉**

* ブートストラップ/内蔵周辺機能が絡むピンで軽微な影響が出ることあり。
* 対策：LED用は **18,19,21,22,23,25–27,32,33** などの“無難ピン”を選択。LEDC等の他ペリフェラルに割り当てていないかも確認。

6. **カメラで見たときだけ揺れる**

* 肉眼では安定でも、室内照明や露出制御とのビートで**動画だけチラつく**。
* 対策：撮影時はLEDをシンク駆動＋十分な電源デカップリング。PWMなら10–20kHz以上。

---

## 切り分け手順（最短コース）

1. **コード簡略化**：そのGPIOを`OUTPUT`にして`HIGH(=1)`固定だけにする。
2. **無線OFF**：Wi-Fi/BLEを無効にして様子を見る（消えれば電源系）。
3. **シンク駆動へ変更**：配線を入れ替え、GPIO=LOWで点灯に。
4. **電源強化**：電解（5V側470–1000µF、3.3V側47–100µF）＋0.1µFを近接配置。別USB電源/ACアダプタでも試す。
5. **ピン替え**：上記“無難ピン”へ変更。`pullup/pulldown`無効、`drive_cap`を1段上げる。

これでほぼ解消します。もしまだ揺れるなら、**オシロで3.3VとGPIO電圧**を観測すると原因（電源窪み or ドライバ不足 or外来ノイズ）が一発で分かります。
