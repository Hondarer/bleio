# WS2812B シリアル LED 機能追加の検討

WS2812B シリアル LED を制御する機能を bleio に追加するための検討内容をまとめます。

## WS2812B シリアル LED の概要

WS2812B は、1 本の信号線でカラー LED (RGB) を制御できるシリアル LED ドライバ IC です。複数の LED を数珠つなぎに接続し、1 本の信号線で各 LED の色を個別に制御できます。

### 基本仕様

**信号方式**

1 線式のシリアル通信で、PWM 信号のパルス幅によってデータを表現します。

**タイミング仕様 (標準)**

| 項目 | 0 ビット | 1 ビット |
|------|---------|---------|
| HIGH 時間 | 0.4[µs] | 0.8[µs] |
| LOW 時間 | 0.9[µs] | 0.5[µs] |
| 合計周期 | 1.3[µs] | 1.3[µs] |

リセット信号は LOW を 50[µs] 以上保持することで発行します。

**データフォーマット**

1 個の LED につき 24 ビット (GRB 順、各色 8 ビット) のデータを送信します。

- G (Green): 8 ビット (MSB ファースト)
- R (Red): 8 ビット (MSB ファースト)
- B (Blue): 8 ビット (MSB ファースト)

数珠つなぎされた LED チェーンの場合、先頭の LED から順番にデータを送信します。

**電源仕様**

- 動作電圧: 5[V]
- 1 個の LED あたりの最大電流: 約 60[mA] (全点灯、白色、最大輝度の場合)

## 使用可能なピン

WS2812B 制御には、ESP32 の RMT (Remote Control) ペリフェラルを使用します。RMT は任意の GPIO ピンに割り当て可能です。

### RMT ペリフェラル仕様

**ESP32 の RMT チャネル数**

ESP32 (ESP32-WROOM-32) は 8 チャネルの RMT を搭載しています。

**使用可能な GPIO ピン**

bleio で使用可能な GPIO のうち、出力が可能なピンであればすべて使用できます。

- GPIO2, GPIO12, GPIO13, GPIO14, GPIO15, GPIO16, GPIO17, GPIO18, GPIO19, GPIO21, GPIO22, GPIO23, GPIO25, GPIO26, GPIO27, GPIO32, GPIO33

ただし、以下のピンは内部用途に予約されているため使用できません。

- GPIO4: ボンディング情報クリア判定用
- GPIO5: 認証機能有効 / 無効判定用

### 推奨ピン

信号品質を考慮すると、以下のピンが推奨されます。

- GPIO18, GPIO19, GPIO21, GPIO22, GPIO23 (比較的ノイズに強い)

### 制限事項

- 同時に使用できる WS2812B 出力は最大 8 チャネル (RMT チャネル数の制限)
- 入力専用ピン (GPIO34, GPIO35, GPIO36, GPIO39) は使用できません

## プロトコル仕様の拡張

### 新規コマンドの追加

WS2812B 制御のため、以下のコマンドを追加します。
また、GPIO 書き込みキャラクタリスティックの Param の長さを 4 に拡張します。
さらに、現在のコマンド値 11 (SET_INPUT_FLOATING) ~ 22 (SET_ADC_DISABLE) を、81~ に割り当て直す。

| コマンド値 | 名称 | 説明 |
|----------|------|------|
| 11 | SET_OUTPUT_WS2812B_ENABLE | WS2812B 出力モードを有効化する (Param1: LED 個数、Param2: 基準輝度、Param3, Param4: 未使用) |
| 12 | SET_OUTPUT_WS2812B_BASECOLOR | WS2812B の基本出力色を設定する (Param1: LED 番号、Param2: R、Param3: G、Param4: B) |

### 使用例

#### WS2812B 出力モードを有効化

GPIO18 に接続された 10 個の LED チェーンを有効化する場合

```text
[0x01, 0x12, 0x0B, 0x0A, 0xFF, 0x00, 0x00]
```

- 0x01: コマンド個数 (1 個)
- 0x12: ピン番号 (GPIO18 = 0x12 = 18)
- 0x0B: コマンド (SET_OUTPUT_WS2812B_ENABLE = 11 = 0x0B)
- 0x0A: Param1 (LED 個数 = 10)
- 0x00: Param2 (基準輝度 = 100%)

#### LED データを書き込み

GPIO18 の LED 3 個に色を設定する場合 (LED1: 赤、LED2: 緑、LED3: 青)

```text
[0x03, 0x12, 0x0C, 0x01, 0xFF, 0x00, 0x00, 0x0C, 0x02, 0x00, 0xFF, 0x00, 0x0C, 0x03, 0x00, 0x00, 0xFF,]
```

- 0x03: コマンド個数 (3 個)
- 0x12: ピン番号 (GPIO18)
- 0x0B: コマンド (SET_OUTPUT_WS2812B_BASECOLOR = 12 = 0x0C)
- 0x01, 0xFF, 0x00, 0x00: LED1 (R=255, G=0, B=0) → 赤
- 0x02, 0x00, 0xFF, 0x00: LED2 (R=0, G=255, B=0) → 緑
- 0x03, 0x00, 0x00, 0xFF: LED3 (R=0, G=0, B=255) → 青

### 必要なライブラリ

ESP-IDF の RMT ドライバを使用します。`platformio.ini` への追加は不要です (ESP-IDF に標準で含まれています)。

## 物理配線例

### 単一 LED チェーンの配線

```text
ESP32 (GPIO18) ──┐
                  │
                  ├─── WS2812B LED 1 ──┬─── WS2812B LED 2 ──┬─── ... ──┬─── WS2812B LED N
                  │                     │                     │          │
5[V] 電源 ────────┴─────────────────────┴─────────────────────┴──────────┴───
GND ──────────────────────────────────────────────────────────────────────────
```

### 配線の詳細

**信号線**

- ESP32 の GPIO (例: GPIO18) から WS2812B LED チェーンの DIN (Data In) に接続
- 最後の LED の DOUT (Data Out) は開放

**電源**

- WS2812B LED の VCC を 5[V] 電源に接続
- WS2812B LED の GND を GND に接続
- ESP32 の GND と WS2812B LED の GND を共通接続 (重要)

**注意事項**

- ESP32 の GPIO は 3.3[V] ロジックですが、WS2812B は 5[V] 電源で動作する場合でも 3.3[V] 信号で制御可能です (ただし、一部の WS2812B では動作が不安定になる場合があります)
- 信号品質を向上させるため、信号線に 330[Ω] ~ 470[Ω] の抵抗を直列に接続することを推奨します
- LED チェーンが長い場合 (10 個以上)、信号線にレベル変換 IC (3.3[V] → 5[V]) を使用することを推奨します

### レベル変換を使用した配線 (推奨)

```text
ESP32 (GPIO18) ──┬─── 74HCT245 (3.3V→5V) ──┬─── WS2812B LED 1 ──┬─── ...
                  │                          │                   │
3.3[V] ───────────┤                          │                   │
5[V] ──────────────┴──────────────────────────┴───────────────────┴───
GND ───────────────────────────────────────────────────────────────────
```

**推奨レベル変換 IC**

- 74HCT245 (8 ビット双方向バスバッファ)
- 74AHCT125 (クワッドバスバッファゲート)

## 回路図例

### WS2812B LED 接続回路

```text
        ESP32
       GPIO18 ────┬── R1 (330Ω) ──┬─── WS2812B LED チェーン (DIN)
                  │                │
                  │                │
       3.3V ──────┤                │
       5V ────────┴────────────────┴─── WS2812B VCC
       GND ──────────────────────────── WS2812B GND
```

**部品表**

| 部品 | 値 / 型番 | 説明 |
|------|----------|------|
| R1 | 330[Ω] ~ 470[Ω] | 信号線保護抵抗 |
| LED | WS2812B LED テープまたは個別 LED | 5[V] 電源、GRB 順 |

### 電源の考慮事項

**電流計算**

1 個の LED あたり最大 60[mA] (全点灯、白色、最大輝度) と仮定します。

- 10 個の LED: 10 × 60[mA] = 600[mA]
- 30 個の LED: 30 × 60[mA] = 1800[mA] = 1.8[A]
- 100 個の LED: 100 × 60[mA] = 6000[mA] = 6[A]

**電源容量**

LED 個数に応じて適切な容量の電源を選定してください。

- 10 個以下: USB 電源 (5[V] / 1[A]) で可能
- 30 個以下: AC アダプタ (5[V] / 2[A] 以上) を推奨
- 100 個以上: 専用電源 (5[V] / 10[A] 以上) が必要

**電源配線**

LED チェーンが長い場合、先頭と末尾の両方から電源を供給することで電圧降下を防ぎます。

## 既存機能との競合

### PWM 機能

WS2812B は RMT ペリフェラルを使用し、PWM は LEDC ペリフェラルを使用するため、ハードウェアリソースの競合はありません。

### ADC 機能

WS2812B は出力のみで、ADC は入力のみのため、競合しません。

### 点滅機能

WS2812B モードに設定されたピンは、点滅機能を無効化します (既存のロジックと同様)。

## 参考資料

- [WS2812B データシート](https://cdn-shop.adafruit.com/datasheets/WS2812B.pdf)
- [ESP-IDF RMT ドライバ](https://docs.espressif.com/projects/esp-idf/en/latest/esp32/api-reference/peripherals/rmt.html)
- [ESP32 RMT による WS2812B 制御例](https://github.com/espressif/esp-idf/tree/master/examples/peripherals/rmt/led_strip)

## まとめ

WS2812B シリアル LED 機能を bleio に追加することで、複数の RGB LED を簡単に制御できるようになります。ESP32 の RMT ペリフェラルを使用することで、正確なタイミングでデータを送信でき、既存の PWM や ADC 機能とも競合しません。

実装の難易度は中程度で、ESP-IDF の RMT ドライバを使用すれば比較的容易に実現できます。フェーズ 1 の最小実装から開始し、段階的に機能を拡張していくことを推奨します。
