# ESP32 から警子ちゃんへの接続回路

## 接続先の仕様

警子ちゃんの入力端子は、以下の仕様を持ちます。

- チャンネル数: 4[ch]
- 入力方式: フォトカプラ入力 (無電圧接点入力、マイナスコモン)
- 定格: 最大 24[V]DC、7[mA]、絶縁タイプ
- 端子構成: 端子番号 1～4 とコモン端子

各端子の機能は次の通りです。

- 端子 1: 赤ランプ
- 端子 2: 黄ランプ
- 端子 3: 緑ランプ
- 端子 4: ブザー 1 (PPPP...)

端子とコモン間を Make (短絡) すると、端子 1～3 はランプが点灯し、端子 4 はブザーが鳴動します。  
端子とコモン間の Make 状態が継続しているときに警子ちゃんの復帰ボタンを押下すると、警子ちゃんのランプやブザーは消灯、停止します。  
端子とコモン間を Open すると、警子ちゃんのランプやブザーは消灯、停止します。

## 回路の基本構成

ESP32 の GPIO から、フォトカプラを使って各端子とコモン端子の間を短絡させる回路を設計します。各チャンネルごとに同じ回路を 4 セット用意します。

### 必要な部品 (1 チャンネルあたり)

- フォトカプラ: PC817 または TLP181 など (出力耐圧 35[V] 以上、CTR 50[%] 以上)
- 電流制限抵抗 (LED 側): 220[Ω] (推奨) または 330[Ω]
- 抵抗の定格: 1/4[W]

### 回路図

```text
【ESP32 側】                 【入力端子側】

GPIO -----[220Ω]----+       端子1 (赤ランプ)
                    |         |
                 [PC817]      |
                    |         |
GND ----------------+       コモン

GPIO -----[220Ω]----+       端子2 (黄ランプ)
                    |         |
                 [PC817]      |
                    |         |
GND ----------------+       コモン

GPIO -----[220Ω]----+       端子3 (緑ランプ)
                    |         |
                 [PC817]      |
                    |         |
GND ----------------+       コモン

GPIO -----[220Ω]----+       端子4 (ブザー)
                    |         |
                 [PC817]      |
                    |         |
GND ----------------+       コモン
```

### フォトカプラ (PC817) のピン接続

PC817 は DIP4 パッケージで、各チャンネルごとに以下のように接続します。

- ピン 1 (アノード A): ESP32 GPIO (220Ω 経由)
- ピン 2 (カソード K): ESP32 GND
- ピン 3 (エミッタ E): 入力端子のコモン
- ピン 4 (コレクタ C): 入力端子の各端子 (1～4)

### 動作原理

ESP32 の GPIO を HIGH にすると、フォトカプラの LED が点灯します。これにより、フォトカプラの出力側トランジスタが ON になり、端子とコモン間が短絡されます。その結果、入力端子側の機器 (ランプやブザー) が動作します。

## 電流制限抵抗の算出根拠

### 前提条件

ESP32 GPIO の仕様は次の通りです。

- 出力電圧: 3.3V
- GPIO 最大出力電流: 40mA (推奨は 12mA 以下)

PC817 フォトカプラの仕様は次の通りです。

- LED 順方向電圧 (Vf): 約 1.2[V] (typ)
- LED 推奨順方向電流 (If): 5～20[mA]
- CTR (電流伝達率): 50～600[%] (ランクにより異なる、最低値 50[%] で計算)

入力端子側の要求は次の通りです。

- 必要な電流: 7[mA]

### 必要な LED 電流の算出

出力側で 7[mA] を流すために必要な入力側電流を、CTR 50[%] (最悪値) で計算します。

```text
If = Ic / CTR = 7[mA] / 0.5 = 14[mA]
```

ただし、PC817 の一般的な CTR は 100[%] 程度あるため、実際には 7～10[mA] で十分です。安全を見て 10[mA] を目標にします。

### 抵抗値の算出

オームの法則から抵抗値を計算します。

```text
R = (Vcc - Vf) / If
R = (3.3V - 1.2V) / 10[mA]
R = 2.1[V] / 0.01[A]
R = 210[Ω]
```

### E12 系列での選定

210[Ω] に近い標準抵抗値から選びます。

- 220[Ω] → If ≈ 9.5[mA] (推奨)
- 330[Ω] → If ≈ 6.4[mA] (CTR が高ければ問題なし)
- 150[Ω] → If ≈ 14[mA] (ESP32 に負荷が大きい)

### 推奨値

実用的には以下の範囲で選択できます。

| 抵抗値 | LED 電流 | 出力電流 (CTR=100%) | 備考 |
|--------|----------|---------------------|------|
| 220[Ω] | 9.5[mA] | 9.5[mA] | 推奨 |
| 330[Ω] | 6.4[mA] | 6.4[mA] | CTR が高ければ OK |
| 470[Ω] | 4.5[mA] | 4.5[mA] | CTR 150[%] 以上必要 |

より確実な動作のため、220[Ω] を推奨します。330[Ω] でも PC817 の CTR が 100[%] 以上あれば 7[mA] の出力は得られますが、マージンを考慮すると 220[Ω] が安全です。

## 部品リスト (4 チャンネル分)

- フォトカプラ PC817: 4 個
- 抵抗 220[Ω] (1/4[W]): 4 個
- ユニバーサル基板またはブレッドボード: 1 枚
- 端子台 (コモン含めて 5 端子): 1 個

## 注意点

マイナスコモン (コモンがマイナス側) の仕様なので、フォトカプラのエミッタをコモン側、コレクタを各端子側に接続する必要があります。
