# LED 点灯パターンに関する機能仕様

本ドキュメントでは、LEDの点灯パターンに関する拡張仕様について述べる。

## LED 点灯パターンモジュールの基本仕様

### 保守性、独立性

LED 点灯パターンモジュールは、点灯パターンごとに保守性、独立性を持たせること。
ファイルを分割しておくことが望ましい。

### 基準クロック

各 LED 点灯パターンモジュールは、esp32 側の割り込みにより、10[ms] 周期で動作する。  
アルゴリズムの都合でカウンターを実装する場合、長時間連続運用した場合にローテートしても不正な点灯状態にならないようローテート条件を設計すること。

### 総合的な明度

総合的な明度は、SET_OUTPUT_WS2812B_ENABLE で設定された基準輝度が勘案される。

## 設定方法

新たなコマンドを用意する。

| コマンド値 | 名称 | 説明 |
|----------|------|------|
| 0x13 | SET_OUTPUT_WS2812B_PATTERN | WS2812B 出力パターンを設定する (Param1: LED 番号、Param2: パターンタイプ、Param3-4: パターンパラメータ) |

**LED 番号の扱い**

- **LED 番号 0**: 当該 GPIO に接続されているすべての LED に適用 (GPIO 全体)
- **LED 番号 1-255**: 個別の LED にパターンを設定

## LED 点灯パターンモジュールのレパートリー

以下に LED 点灯パターンモジュールのレパートリーを示す。  
今後、拡張されることを念頭に、拡張性を考慮した実装とすること。

### PATTERN_ON: 点灯

常に 100[%] の状態を返す。デフォルト。

### PATTERN_BLINK: 周期で点滅

点灯 250[ms]、消灯 250[ms] を繰り返す。  
色は SET_OUTPUT_WS2812B_BASECOLOR で設定されたものを用いる。  
LED 番号によらず、すべての明滅タイミングはシステム立ち上がり時からの基準クロックに従う。

#### 注意事項

2 値出力の SET_OUTPUT_BLINK_250MS の点滅タイミングも同時になるよう、処理を検討・修正し対処すること。

### PATTERN_BLINK_500MS: 1000[ms] 周期で点滅

点灯 500[ms]、消灯 500[ms] を繰り返す。
色は SET_OUTPUT_WS2812B_BASECOLOR で設定されたものを用いる。
LED 番号によらず、すべての明滅タイミングはシステム立ち上がり時からの基準クロックに従う。

#### 注意事項

2 値出力の SET_OUTPUT_BLINK_500MS の点滅タイミングも同時になるよう、処理を検討・修正し対処すること。

### PATTERN_RAINBOW: 虹色

@shindoi-lighting-patterns.md に記載のあるアルゴリズムを esp32 向けに実装し、虹色点灯を行う。  
SET_OUTPUT_WS2812B_BASECOLOR で設定された色は本パターンでは無視される。  

パラメータで、色相が一周する LED 個数と、変化スピードを決定する。

**Param3: 色相が一周する LED 個数 (1-16)**

10 個の LED で色相を 2 周させたい場合は 5 を指定します。

**Param4: 変化スピード (0-255)**

10ms ごとに加算される色相の増加量を決定します (実際の加算値 = Param4 × 8)。

| Param4 | 加算値/10ms | 1秒あたりの変化 | 一周時間 | 視覚効果 |
|--------|------------|----------------|----------|----------|
| 0 | 1024 | 102,400 | 約 0.64秒 | デフォルト (中速) |
| 1 | 8 | 800 | 約 82秒 (1.4分) | 非常にゆっくり |
| 64 | 512 | 51,200 | 約 1.28秒 | やや遅い |
| 128 | 1024 | 102,400 | 約 0.64秒 | 中速 |
| 255 | 2040 | 204,000 | 約 0.32秒 | 高速 |

ここで、パターン設定時の各LEDの色相は、システム立ち上がり時からの基準クロックと LED 番号で一意に決定される。  
つまり、

- システム立ち上がり時からの基準クロック
- LED 番号
- 色相が一周する LED 個数
- 変化スピード

により、LED の R, G, B が一意に求まるアルゴリズムを実装する。

**実装詳細**

実装は以下のアルゴリズムを使用します。

1. **HSV から RGB への変換**: shindoi-lighting-patterns.md の ColorHSV アルゴリズムを ESP32 向けに実装
2. **ガンマ補正**: ガンマ値 2.6 のルックアップテーブル (gamma8) を使用
3. **色相の更新**: 10[ms] ごとに色相を加算 (加算値 = 変化スピード × 8)
4. **色相オフセット**: LED インデックスに応じて色相をオフセット (オフセット = LED 番号 × 65536 / 色相が一周する LED 個数)

**処理フロー**

```c
// 色相が一周する LED 個数 (Param3: 1-16)
uint8_t hue_period = pattern_param1;
if (hue_period == 0) hue_period = 12; // デフォルト

// 色相オフセットの計算
uint16_t hue_offset = (led_index * 65536) / hue_period;
uint16_t current_hue = pattern->hue + hue_offset;

// HSV → RGB 変換 (彩度 255、明度は基準輝度)
uint32_t rgb = ws2812b_color_hsv(current_hue, 255, brightness);

// ガンマ補正
rgb = gamma32(rgb);

// 色相の更新 (10ms ごと)
uint16_t speed = pattern_param2;
if (speed == 0) speed = 128; // デフォルト
uint16_t hue_increment = speed * 8; // チューニング係数
pattern->hue += hue_increment;
```

**注意事項**

- PATTERN_ON は変化しないため、初回設定以降は更新不要
- BLINK 系は global_blink_counter が変化したときのみ更新 (25 回に 1 回、250ms ごと)
- RAINBOW は 10ms ごとに更新

### PATTERN_UNSET: 個別設定クリア

個別の LED に設定されたパターンをクリアし、GPIO 全体のパターン (LED 番号 0 で設定されたパターン) に戻す。

**パターンタイプ値**

`0xFF`

**適用対象**

- 個別 LED (LED 番号 1-255) にのみ設定可能
- LED 番号 0 (GPIO 全体) には設定できません

**動作**

個別パターンがクリアされ、その LED は GPIO 全体のパターンを継承します。

**使用例**

GPIO18 の LED1 に個別設定があり、それをクリアして GPIO パターンに戻す場合

```c
// LED1 の個別パターンをクリア
gpio_set_ws2812b_pattern(18, 1, WS2812B_PATTERN_UNSET, 0, 0);
```

この設定により、LED1 は GPIO 全体のパターン (LED 番号 0 で設定されたパターン) を継承します。
