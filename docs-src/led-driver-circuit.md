# LED 駆動回路設計

ESP32 の GPIO 出力から 2N7000 MOSFET を使用して、5[V] バスから 2.0[V] 10[mA] の LED を点灯させる回路を説明します。

## 回路概要

ESP32 の GPIO (3.3[V] ロジック) で 2N7000 N-channel MOSFET をスイッチングし、5[V] 電源から LED へ電流を供給します。LED は順方向電圧 (Vf) が 2.0[V]、駆動電流が 10[mA] の仕様とします。

## 回路図

![led-driver-circuit.drawio](images/led-driver-circuit.drawio.svg)

## 部品リスト

| 部品 | 仕様 | 用途 |
|------|------|------|
| Q1 | 2N7000 N-channel MOSFET | スイッチング素子 |
| R1 | 300[Ω] 1/4[W] 抵抗 | LED 電流制限抵抗 |
| R2 | 10[kΩ] 抵抗 | ゲート保護抵抗 |
| R3 | 100[kΩ] 抵抗 | ゲートプルダウン抵抗 |
| LED1 | 順方向電圧 2.0[V] 10[mA] LED | 表示素子 |

## 設計計算

### LED 電流制限抵抗の計算

LED に流れる電流を 10[mA] に制限するための抵抗値を計算します。

**条件**

- 電源電圧 (Vcc): 5[V]
- LED 順方向電圧 (Vf): 2.0[V]
- LED 駆動電流 (If): 10[mA]
- 2N7000 オン抵抗 (Rds(on)): 約 5[Ω] (Vgs=3.3[V] 時)

**計算式**

```text
R1 = (Vcc - Vf - Vds) / If
```

Vds は MOSFET のドレイン-ソース間電圧降下で、オン抵抗による電圧降下です。

```text
Vds = Rds(on) × If = 5[Ω] × 10[mA] = 0.05[V]
```

したがって、

```text
R1 = (5[V] - 2.0[V] - 0.05[V]) / 10[mA]
   = 2.95[V] / 10[mA]
   = 295[Ω]
```

**標準抵抗値の選定**

E12 系列で 295[Ω] に近い値は 300[Ω] です。実際の電流は以下のようになります。

```text
If = (5[V] - 2.0[V] - 0.05[V]) / 300[Ω]
   = 2.95[V] / 300[Ω]
   = 9.83[mA]
```

これは 10[mA] の仕様に対して十分近い値です。

### 2N7000 の動作条件確認

**ゲート-ソース間電圧 (Vgs)**

ESP32 の GPIO HIGH レベルは 3.3[V] なので、Vgs = 3.3[V] で動作します。

**スレッショルド電圧 (Vgs(th))**

2N7000 のデータシートによると、Vgs(th) は 0.8[V]〜3.0[V] (typ. 2.1[V]) です。Vgs = 3.3[V] であれば、確実にオン状態になります。

**ドレイン電流 (Id)**

LED 駆動電流は約 10[mA] で、2N7000 の最大定格 (200[mA]) に対して十分余裕があります。

**オン抵抗 (Rds(on))**

Vgs = 4.5[V] 時のデータシートでは Rds(on) = 5[Ω] (typ.) です。Vgs = 3.3[V] では若干高くなる可能性がありますが、10[mA] の電流では Vds = 0.05[V] 程度の電圧降下で問題ありません。

### ゲート抵抗の選定

**ゲート保護抵抗 (R2)**

GPIO ピンを保護するため、10[kΩ] の抵抗を直列に接続します。MOSFET のゲートは容量性負荷なので、スイッチング時の突入電流を制限します。

**プルダウン抵抗 (R3)**

ESP32 起動時や GPIO が未設定状態のとき、ゲートをフロート状態にしないため、100[kΩ] のプルダウン抵抗を接続します。これにより、意図しない LED 点灯を防ぎます。

## 実装上の注意点

### ESP32 GPIO の設定

bleio サーバーの GPIO 制御 API を使用して、以下のように設定します。

```{.c caption="GPIO制御例"}
// GPIO を出力モードに設定
gpio_set_direction(GPIO_NUM_XX, GPIO_MODE_OUTPUT);

// LED 点灯 (GPIO HIGH)
gpio_set_level(GPIO_NUM_XX, 1);

// LED 消灯 (GPIO LOW)
gpio_set_level(GPIO_NUM_XX, 0);
```

### PWM による調光

bleio の PWM 機能を使用すれば、LED の明るさを調整できます。

```{.c caption="PWM設定例"}
// PWM 設定例 (周波数 1[kHz]、デューティ比 50%)
// protocol.md の PWM コマンド仕様を参照
```

C# クライアントからは以下のように制御できます。

```{.csharp caption="クライアントからのPWM制御"}
// LED を 50% の明るさで点灯
await client.SetPwmAsync(gpioPin, frequency: 1000, dutyCycle: 50);
```

### 電源の考慮事項

5[V] 電源と ESP32 の GND は共通にする必要があります。bleio システムでは、USB 給電または外部 5[V] 電源から ESP32 の Vin ピンに供給することを想定しています。

詳細は [power-circuit.md](power-circuit.md) を参照してください。

## 応用例

### 複数 LED の制御

複数の GPIO ピンを使用すれば、同じ回路を並列に接続して複数の LED を独立制御できます。

### リレー駆動

2N7000 の代わりに耐圧の高い MOSFET (例: IRF540N) を使用すれば、リレーコイルを駆動してより大きな負荷をスイッチングできます。

### ブザー駆動

LED の代わりに圧電ブザーを接続し、PWM で周波数を変えることで音階を鳴らすことができます。

## 関連ドキュメント

- [プロトコル仕様](protocol.md): GPIO および PWM 制御コマンド
- [クライアント API](client-interface.md): C# からの制御方法
- [電源回路](power-circuit.md): 5V 電源の供給方法
